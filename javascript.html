<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=GBK">
	<title>Document</title>
</head>
<body>
	<script type="text/javascript">
		var Interface = function(name, methods){
			if(arguments.length != 2){
				throw new Error("Interface constructor called with " + arguments.length +
					"arguments, but expected exactly 2.");
			}	
			this.name = name;
			this.methods = [];
			for (var i = 0,len = methods.length; i < len; i++) {
				if(typeof methods[i] !== "string"){
					throw new Error("Interface constructor expects method names to be "
						+ "passed in as a string.");
				}
				this.methods.push(methods[i]);
			};
		}

		Interface.ensureImplements = function(object){
			if(arguments.length < 2){
				throw new Error("Function Interface.ensureImplements called with " + arguments.length +
					"arguments, but expected at least 2.");
			}
			for(var i = 1, len = arguments.length; i < len; i++){
				var interface = arguments[i];
				if(interface.constructor !== Interface){
					throw new Error("Function Interface.ensureImplements expects arguments two and above "
						+ "to be instances of Interface.");
				}
				for(var j = 0, methodsLen = interface.methods.length; j < methodsLen; j++){
					var method = interface.methods[j];
					if(!object[method] || typeof object[method] !== 'function'){
						throw new Error("Function Interface.ensureImplements: object does not "
						+ "implement the " + interface.name + " interface. Method" + method
						+ " was not found.");
					}
				}
			}
		}

		function extend(subClass, superClass){
			var F = function(){};
			F.prototype = superClass.prototype;
			subClass.prototype = new F();
			subClass.prototype.constructor = subClass;

			subClass.superClass = superClass.prototype;
			if(superClass.prototype.constructor == Object.prototype.constructor){
				superClass.prototype.constructor = superClass;
			}
		}

		function clone(object){
			function F(){}
			F.prototype = object;
			return new F;
		}

		function argument(receivingClass, givingClass){
			if(arguments[2]){
				for(var i = 2,len = arguments.length; i < len; i++){
					receivingClass.prototype[arguments[i]] = givingClass.prototype[arguments[i]];
				}
			}else{
				for(methodName in givingClass.prototype){
					if(!receivingClass.prototype[methodName]){
						receivingClass.prototype[methodName] = givingClass.prototype[methodName];
					}
				}
			}
		}

		/**
		 * 调用链的结构
		 */
		
		(function(){

			Function.prototype.method = function(name, fn){
				this.prototype[name] = fn;
				return this;	
			}

			function _$(els){
				this.elements = [];
				for(var i = 0, len = els.length; i < len; ++i){
					var element = els[i];
					if(typeof element === 'string'){
						element = document.getElementById(element);
					}
					this.elements.push(element);
				}
			}

			window.$ = function(){
				return new _$(arguments);
			}

			window.installHelper = function(scope, interface){
				scope[Interface] = function(){
					return new _$(arguments);
				}
			}

			_$.method('each', function(fn){
				for(var i = 0,len = this.elements.length; i < len; ++i){
					fn.call(this, this.elements[i]);
				}
				return this;
			}).method('setStyle', function(prop, value){
				this.each(function(el){
					el.style[prop] = value;
				})
				return this;
			}).method('show', function(){
				var that = this;
				this.each(function(el){
					that.setStyle('display', 'block');
				});
				return this;
			}).method('addEvent', function(type, fn){
				var add = function(el){
					if(window.addEventListener){
						el.addEventListener(type, fn, false);
					}else if(window.attachEvent){
						el.attachEvent('on'+type, fn);
					}
				};
				this.each(function(el){
					add(el);
				});
				return this;
			})
			
		})()

		window.com = window.com || {};
		com.example = com.example || {};
		com.example.util = com.example.util || {};

		installHelper(com.example.util, 'get');

		$(window).addEvent('load', function(){
			$('a','b').show().setStyle('color','red').addEvent('click', function(e){
				$(this).setStyle('color', 'green');
			});
		});

/*************************************************设计模式************************************************/
		
	/******** 1.工厂模式 *********/

		/* BicycleShop class. */
		/*var BicycleShop = function(){};
		BicycleShop.prototype = {
			sellBicycle: function(model){
				var bicycle;
				switch(model){
					case 'The Speedster':
						bicycle = new Speedster();
						break;
					case 'The Lowrider':
						bicycle = new Lowrider();
					case 'The Comfort Cruiser':
					default:
						bicycle = new ComfortCruiser();
				}
				Interface.ensureImplements(bicycle, Bicycle);
				bicycle.assemble();
				bicycle.wash();

				return bicycle;
			}
		}*/

		/* The Bicycle interface. */
		var Bicycle = new Interface('Bicycle', ['assemble', 'wash', 'ride', 'repair']);
		
		/* Speedster class. */
		var Speedster = function(){
			//TODO implements Bicycle
		}
		Speedster.method('assemble', function(){

		}).method('wash',function(){

		}).method('ride',function(){

		}).method('repair',function(){

		})

		/* BicycleFactory namespace. */
		var BicycleFactory = {
			createBicycle: function(model){
				var bicycle;
				switch(model){
					case 'The Speedster':
						bicycle = new Speedster();
						break;
					case 'The Lowrider':
						bicycle = new Lowrider();
						break;
					case 'The Flatlander':
						bicycle = new Flatlander();
						break;
					case 'The Comfort Cruiser':
					default:
						bicycle = new ComfortCruiser();
				}

				Interface.ensureImplements(bicycle, Bicycle);
				return bicycle;
			}
		}

		/* BicycleShop class, improved. */
		/*var BicycleShop = function(){};
		BicycleShop.prototype = {
			sellBicycle: function(model){
				var bicycle = BicycleFactory.createBicycle(model);
				
				bicycle.assemble();
				bicycle.wash();

				return bicycle;
			}
		}*/

		/* BicycleShop class (abstract). */
		var BicycleShop = function(){};
		BicycleShop.prototype = {
			sellBicycle: function(model){
				var bicycle = this.createBicycle(model);
				
				bicycle.assemble();
				bicycle.wash();

				return bicycle;
			},
			createBicycle: function(model){
				throw new Error('Unsupported operation on an abstract class.');
			}
		}

		/* AcmeBicycleShop class.*/
		var AcmeBicycleShop = function(){};
		extend(AcmeBicycleShop, BicycleShop);
		AcmeBicycleShop.prototype.createBicycle = function(model){
			var bicycle;
			switch(model){
				case 'The Speedster':
					bicycle = new AcmeSpeedster();
					break;
				case 'The Lowrider':
					bicycle = new AcmeLowrider();
					break;
				case 'The Flatlander':
					bicycle = new AcmeFlatlander();
					break;
				case 'The Comfort Cruiser':
				default:
					bicycle = new AcmeComfortCruiser();
			}
			Interface.ensureImplements(bicycle, Bicycle);
			return bicycle;	
		}

		/* GeneralProductsBicycleShop class.*/
		var GeneralProductsBicycleShop = function(){};
		extend(GeneralProductsBicycleShop, BicycleShop);
		GeneralProductsBicycleShop.prototype.createBicycle = function(model){
			var bicycle;
			switch(model){
				case 'The Speedster':
					bicycle = new GeneralProductsSpeedster();
					break;
				case 'The Lowrider':
					bicycle = new GeneralProductsLowrider();
					break;
				case 'The Flatlander':
					bicycle = new GeneralProductsFlatlander();
					break;
				case 'The Comfort Cruiser':
				default:
					bicycle = new GeneralProductsComfortCruiser();
			}
			Interface.ensureImplements(bicycle, Bicycle);
			return bicycle;	
		}

		/*** XHR工厂 ***/
		
		/* AjaxHandler interface */
		var AjaxHandler = new Interface('AjaxHandler', ['request','createXhrObject']);

		/* SimpleHandler class. */
		var SimpleHandler = function(){}; //implements AjaxHandler
		SimpleHandler.prototype = {
			request: function(method, url, callback, postVars){
				var xhr = this.createXhrObject();
				xhr.onreadystatechange = function(){
					if(xhr.readyState !== 4) return;
					(xhr.status === 200) ? 
						callback.success(xhr.responseText, xhr.responseXML) :
						callback.failure(xhr.status);
				};
				xhr.open(method, url, true);
				if(method !== 'POST') postVars = null;
				xhr.send(postVars);
			},
			createXhrObject: function(){ //Factory method.
				var methods = [
					function(){ return new XMLHttpRequest(); },
					function(){ return new ActiveXObject('Msxml2.XMLHTTP'); },
					function(){ return new ActiveXObject('Microsoft.XMLHTTP'); }
				];
				for(var i = 0, len = methods.length; i < len; i++){
					try{
						methods[i]();
					}catch(e){
						continue;
					}
					//If we reach this point,methods[i] worked.
					this.createXhrObject = methods[i]; //Memoize the method.
					return methods[i];
				}
				//If we reach this point, none of the methods worked.
				throw new Error('SimpleHandler: Could not create an XHR object.');
			}
		}

		/* QueueHandler class. */
		var QueueHandler = function(){ //implements AjaxHandler
			this.queue = [];
			this.requestInProgress = false;
			this.retryDelay = 5; //In seconds;
		};
		extend(QueueHandler, SimpleHandler);
		QueueHandler.prototype.request = function(method, url, callback, postVars, override){
			if(this.requestInProgress && !override){
				this.queue.push({
					method: method,
					url: url,
					callback: callback,
					postVars: postVars
				});
			}else{
				this.requestInProgress = true;
				var xhr = this.createXhrObject();
				var that = this;
				xhr.onreadystatechange = function(){
					if(xhr.readyState !== 4) return;
					if(xhr.status === 200){
						callback.success(xhr.responseText, xhr.responseXML);
						that.advanceQueue();
					}else{
						callback.failure(xhr.status);
						setTimeout(function(){
							that.request(method, url, callback, postVars, true);
						}, that.retryDelay * 1000);
					}
				};
				xhr.open(method, url, true);
				if(method !== 'POST') postVars = null;
				xhr.send(postVars);
			}
		}

		QueueHandler.prototype.advanceQueue = function(){
			if(this.queue.length === 0){
				this.requestInProgress = false;
				return;
			}
			var req = this.queue.shift();
			this.request(req.method, req.url, req.callback, req.postVars, true);
		}

		/* OfflineHandler class. */
		var OfflineHandler = function(){ //implements AjaxHandler
			this.storedRequests = [];
		};
		extend(OfflineHandler, SimpleHandler);
		OfflineHandler.prototype.request = function(method, url, callback, postVars){
			if(XhrManager.isOffline()){ //Store the request until we are online.
				this.storedRequests.push({
					method: method,
					url: url,
					callback: callback,
					postVars: postVars
				});
			}else{ //Call SimpleHandler's request method if we are online.
				this.flushStoreRequests();
				OfflineHandler.superClass.request(method, url, callback, postVars);
			}
		};
		OfflineHandler.prototype.flushStoreRequests = function(){
			for(var i = 0, len = storedRequests.length; i < len; i++){
				var req = storedRequests[i];
				OfflineHandler.superClass.request(req.request, req.url, req.callback, req.postVars);
			}
		};
	</script>	

	<script type="text/javascript">
		window.onload = function(){
			var californiaCruisers = new BicycleShop();
			var yourNewBike = californiaCruisers.sellBicycle('The Speedster');
		}
	</script>
	<div id="a" style="display: none">1</div>	
	<div id="b" style="display: none">2</div>	
</body>
</html>